<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{% block title %} Root the Box {% end %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hacker War Game">
    <meta name="author" content="moloch">
    <link rel="shortcut icon" href="/static/images/favicon.ico" />
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet" />
    {% module CssTheme() %}
    <link href="/static/css/animate.css" rel="stylesheet" />
    <link href="/static/css/notifier.css" rel="stylesheet" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }.sidebar-nav {
        padding: 9px 0;
      }
    </style>
    <!--[if lt IE 9]>
      <script src="/static/js/libs/html5.js"></script>
    <![endif]-->
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <script src="/static/js/notifier.js" type="text/javascript" ></script>
    <script src="/static/js/bootstrap.min.js" type="text/javascript"></script>
  </head>
  <body>
    {% module Menu() %}
    <div class="container">
      <div class="animated fadeIn">
          {% block content %} Content Missing {% end %}
      </div><!--/row-->
      <hr>
      <footer>
        <p>
          <a href="http://rootthebox.com" target="_blank">Root the Box</a> &copy; {{ datetime.date.today().year }} -
          <a href="https://github.com/moloch--/RootTheBox" target="_blank">Source Code</a> -
          Version {{ handler.application.settings['version'] }}
        </p>
      </footer>
    </div><!--/.fluid-container--> 
    {% block body %} {% end %}
  </body>

  <!-- JavaScript -->
  <script>
    $(document).ready(function() {
      var ws = new WebSocket("ws://{{ handler.application.settings['ws_ip_address'] }}:{{ handler.application.settings['ws_port'] }}/websocket");
      if (typeof String.prototype.startsWith != 'function') {
          String.prototype.startsWith = function (str){
            return this.indexOf(str) == 0;
          };
      }
      
      ws.onopen = function() {
        // Wait for a notification
        if($('#scoreboard').length){
          // ws.send("load plox");
        }
      };
      
      ws.onmessage = function (evt) {
        message = jQuery.parseJSON(evt.data);
        console.log(message);
        console.log(message['time_stamp']);
        if(message['py/object'] == 'libs.Notification.Notification') {
          // Send a Notification
          Notifier.notify(message['message'], message['title'], "data:image/png;base64,"+message['file_contents']);
        } else if(message['py/object'] == 'libs.ScoreUpdate.ScoreUpdate') {
          if($('#scoreboard').length){
            // Update the line chart
            chart.series[getSeriesByName(message['team_name'])].addPoint(
                [parseInt(message['time_stamp'], 10),
                 getCorrectValue(parseInt(message['value']), getSeriesByName(message['team_name']))]
                );
            // Update the bar chart
            correctData(getSeriesByName(message['team_name']), parseInt(message['value']));
            bar_chart.redraw();
            // Update pie chart
            correctPieData(message['team_name'], getSeriesByName(message['team_name']), parseInt(message['value']));
            pc.redraw();
          } 
        }
      };
      
      function getCorrectValue(newestValue, seriesId) {
        if(chart.series[seriesId].data.length > 0) {
          return chart.series[seriesId].data[chart.series[seriesId].data.length-1].config[1] + newestValue;
        } else {
          return newestValue;
        }
      }
      
      function getSeriesByName(teamName) {
        for(var index = 0; index < chart.series.length; index++) {
          if(chart.series[index].name == teamName) {
            return index;
          }
        }
        return -1;
      }
      
      function correctData(teamIndex, newScore) {
        var new_data = [];
        // Copy all of the team scores that are currently being displayed
        for(var index = 0; index < bar_chart.series[0].data.length; index++) {
           new_data[index] = bar_chart.series[0].data[index].config;
        }
        new_data[teamIndex] += newScore;
        bar_chart.series[0].setData(new_data, false);
      }
      
      function correctPieData(teamName, teamIndex, newScore) {
        var new_data = [];
        // Copy all of the team scores that are currently being displayed
        for(var index = 0; index < pc.series[0].data.length; index++) {
           new_data[index] = pc.series[0].data[index].config;
        }
        new_data[teamIndex][1] += newScore;
        pc.series[0].setData(new_data, false);
      }
      
    });
  </script>
</html>
